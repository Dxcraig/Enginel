# Railway Deployment Guide for Enginel

This guide walks you through deploying the Enginel CAD management platform on Railway.

## üìã Prerequisites

1. **Railway Account**: Sign up at [railway.app](https://railway.app)
2. **GitHub Repository**: Your code should be in a GitHub repository
3. **Railway CLI** (optional): Install with `npm i -g @railway/cli`

## üöÄ Quick Start Deployment

### Method 1: Deploy from GitHub (Recommended)

1. **Connect Repository**
   - Go to [railway.app/new](https://railway.app/new)
   - Click "Deploy from GitHub repo"
   - Select your Enginel repository
   - Railway will automatically detect the Dockerfile

2. **Create Required Services**
   
   You need to create 5 services in Railway:
   - **Web Application** (main Django app)
   - **PostgreSQL Database**
   - **Redis Cache**
   - **Celery Worker** (background tasks)
   - **Celery Beat** (scheduled tasks)

### Method 2: Deploy with Railway CLI

```bash
# Login to Railway
railway login

# Link to existing project or create new one
railway link

# Deploy all services
railway up
```

## üîß Service Configuration

### 1. PostgreSQL Database Service

Railway provides managed PostgreSQL:

1. Click "+ New" ‚Üí "Database" ‚Üí "Add PostgreSQL"
2. Railway automatically creates `DATABASE_URL` environment variable
3. The database is automatically linked to your services

**Environment Variables (Auto-generated):**
- `DATABASE_URL` - Automatically provided by Railway

### 2. Redis Cache Service

Railway provides managed Redis:

1. Click "+ New" ‚Üí "Database" ‚Üí "Add Redis"
2. Railway automatically creates `REDIS_URL` environment variable

**Environment Variables (Auto-generated):**
- `REDIS_URL` - Automatically provided by Railway

### 3. Web Application Service

This is your main Django application.

**Build Configuration:**
- **Builder**: Dockerfile
- **Dockerfile Path**: `Dockerfile`
- **Start Command**: `./entrypoint.sh`

**Required Environment Variables:**

```bash
# Django Core
SECRET_KEY=<generate-secure-key-here>
DEBUG=False
ALLOWED_HOSTS_EXTRA=<your-custom-domain-if-any>

# Database (automatically provided if using Railway PostgreSQL)
DATABASE_URL=<auto-generated-by-railway>

# Redis (automatically provided if using Railway Redis)
REDIS_URL=<auto-generated-by-railway>

# Security
SECURE_SSL_REDIRECT=True
PASSWORD_MIN_LENGTH=12
TOKEN_EXPIRATION_HOURS=24
API_KEY_EXPIRATION_DAYS=365

# Rate Limiting
THROTTLE_ANON=100/hour
THROTTLE_USER=1000/hour

# CSRF & CORS (add your frontend domain if applicable)
CSRF_TRUSTED_ORIGINS=https://your-frontend.com
CORS_ALLOWED_ORIGINS=https://your-frontend.com

# Session
SESSION_COOKIE_AGE=86400

# AWS S3 (Optional - for file storage)
USE_S3=False
# If USE_S3=True, add these:
# AWS_ACCESS_KEY_ID=<your-key>
# AWS_SECRET_ACCESS_KEY=<your-secret>
# AWS_STORAGE_BUCKET_NAME=<your-bucket>
# AWS_S3_REGION_NAME=us-east-1
# AWS_PRESIGNED_URL_EXPIRY=3600

# Email Configuration (Optional)
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=<your-email>
EMAIL_HOST_PASSWORD=<your-app-password>
DEFAULT_FROM_EMAIL=noreply@yourdomain.com

# Gunicorn Configuration
GUNICORN_WORKERS=4
GUNICORN_TIMEOUT=120

# Security Logging
SECURITY_LOG_ATTACKS=True
SECURITY_BLOCK_AFTER_ATTACKS=3
SECURITY_BLOCK_DURATION=86400

# Notifications
NOTIFICATIONS_ENABLED=True
NOTIFICATION_BATCH_SIZE=50
```

**Port Configuration:**
- Railway automatically provides `PORT` environment variable (usually 8000)
- The application binds to `0.0.0.0:$PORT`

### 4. Celery Worker Service

Processes background tasks (geometry processing, file uploads, etc.)

**Build Configuration:**
- **Builder**: Dockerfile
- **Dockerfile Path**: `Dockerfile`
- **Start Command**: `celery -A enginel worker --loglevel=info --concurrency=2`

**Environment Variables:**
- Use the same environment variables as the Web service
- Ensure `DATABASE_URL` and `REDIS_URL` are linked

### 5. Celery Beat Service

Handles scheduled tasks (cleanup, notifications, etc.)

**Build Configuration:**
- **Builder**: Dockerfile
- **Dockerfile Path**: `Dockerfile`
- **Start Command**: `celery -A enginel beat --loglevel=info --schedule=/tmp/celerybeat-schedule`

**Environment Variables:**
- Use the same environment variables as the Web service
- Ensure `DATABASE_URL` and `REDIS_URL` are linked

## üîê Generating SECRET_KEY

Generate a secure SECRET_KEY for production:

```bash
# Using Python
python -c "import secrets; print(secrets.token_urlsafe(50))"

# Using OpenSSL
openssl rand -base64 50

# Using Railway CLI
railway run python -c "import secrets; print(secrets.token_urlsafe(50))"
```

Copy the output and set it as `SECRET_KEY` in Railway.

## üîó Service Linking

Railway automatically links services when they're in the same project:

1. **Database ‚Üí Web/Worker/Beat**: Shared `DATABASE_URL`
2. **Redis ‚Üí Web/Worker/Beat**: Shared `REDIS_URL`

To verify linking:
- Go to service settings ‚Üí "Variables" ‚Üí Check "Reference Variables"

## üìä Health Checks & Monitoring

Railway provides built-in health checks:

**Web Service Health Check:**
- Path: `/admin/` (configured in `railway.toml`)
- Timeout: 100 seconds
- Railway monitors this endpoint

**View Logs:**
```bash
# Via CLI
railway logs

# Via Dashboard
Go to service ‚Üí "Deployments" ‚Üí Click on deployment ‚Üí "View Logs"
```

**View Metrics:**
- CPU Usage
- Memory Usage
- Network Traffic
- Request Count

All available in Railway dashboard under each service.

## üåê Custom Domain Setup

### Add Custom Domain:

1. Go to Web service ‚Üí "Settings" ‚Üí "Domains"
2. Click "Add Domain"
3. Enter your domain (e.g., `api.yourdomain.com`)
4. Add CNAME record to your DNS:
   - Type: `CNAME`
   - Name: `api` (or your subdomain)
   - Value: `<your-project>.up.railway.app`

5. Update environment variables:
```bash
ALLOWED_HOSTS_EXTRA=api.yourdomain.com
CSRF_TRUSTED_ORIGINS=https://api.yourdomain.com
```

### SSL/TLS Certificates:
- Railway automatically provisions and renews SSL certificates
- HTTPS is enabled by default

## üîÑ Deployment Process

### Automatic Deployments:

Railway automatically deploys when you push to your repository:

```bash
git add .
git commit -m "Update application"
git push origin main
```

Railway will:
1. Detect changes
2. Build Docker image
3. Run migrations (via entrypoint.sh)
4. Deploy new version
5. Zero-downtime rollout

### Manual Deployment:

```bash
# Via CLI
railway up

# Via Dashboard
Go to service ‚Üí "Deployments" ‚Üí "Deploy"
```

## üêõ Troubleshooting

### Common Issues:

#### 1. Database Connection Errors

**Problem**: Cannot connect to PostgreSQL
**Solution**:
```bash
# Verify DATABASE_URL is set
railway variables

# Check if PostgreSQL service is running
railway status

# Test connection
railway run python manage.py dbshell
```

#### 2. Redis Connection Errors

**Problem**: Cannot connect to Redis
**Solution**:
```bash
# Verify REDIS_URL is set
railway variables

# Check Redis service status
railway status

# Test Redis connection
railway run python -c "import redis; r = redis.from_url('$REDIS_URL'); print(r.ping())"
```

#### 3. Static Files Not Loading

**Problem**: 404 errors for static files
**Solution**:
- Verify WhiteNoise is installed: `whitenoise` in `requirements.txt`
- Check middleware: `WhiteNoiseMiddleware` is after `SecurityMiddleware`
- Run collectstatic: `railway run python manage.py collectstatic --noinput`

#### 4. CSRF/CORS Errors

**Problem**: CSRF verification failed or CORS errors
**Solution**:
```bash
# Update CSRF_TRUSTED_ORIGINS
railway variables set CSRF_TRUSTED_ORIGINS=https://your-domain.railway.app,https://your-custom-domain.com

# Update CORS_ALLOWED_ORIGINS (if using CORS)
railway variables set CORS_ALLOWED_ORIGINS=https://your-frontend.com
```

#### 5. Worker/Beat Not Processing Tasks

**Problem**: Celery tasks not executing
**Solution**:
```bash
# Check worker logs
railway logs --service celery-worker

# Check beat logs
railway logs --service celery-beat

# Verify Redis connection
railway run --service celery-worker celery -A enginel inspect ping

# Restart services
railway restart --service celery-worker
railway restart --service celery-beat
```

#### 6. Out of Memory Errors

**Problem**: Service crashes due to memory limits
**Solution**:
- Upgrade Railway plan for more memory
- Reduce Gunicorn workers: `GUNICORN_WORKERS=2`
- Reduce Celery concurrency: Update start command to `--concurrency=1`
- Optimize code and queries

#### 7. Timeout Errors

**Problem**: 504 Gateway Timeout
**Solution**:
```bash
# Increase Gunicorn timeout
railway variables set GUNICORN_TIMEOUT=180

# Check for long-running tasks
# Move heavy processing to Celery tasks
```

### View Logs:

```bash
# All services
railway logs

# Specific service
railway logs --service web
railway logs --service celery-worker

# Follow logs in real-time
railway logs -f

# Filter by time
railway logs --since 1h
```

### Access Service Shell:

```bash
# Django shell
railway run python manage.py shell

# Database shell
railway run python manage.py dbshell

# Bash shell
railway run bash
```

## üìà Scaling

### Vertical Scaling (More Resources):

1. Go to Project ‚Üí "Settings" ‚Üí "Resources"
2. Upgrade to higher tier for:
   - More CPU
   - More RAM
   - More concurrent connections

### Horizontal Scaling (More Instances):

Railway Pro plans support:
- Multiple replicas of web service
- Load balancing across replicas

```bash
# Scale web service to 3 replicas
railway scale --service web --replicas 3
```

## üí∞ Cost Optimization

### Tips to Reduce Costs:

1. **Use Railway's Free Tier** ($5 credit/month):
   - Good for development/testing
   - Suitable for low-traffic applications

2. **Optimize Resource Usage**:
   - Reduce Gunicorn workers for low traffic
   - Use smaller database instances during development
   - Set appropriate `CELERY_TASK_TIME_LIMIT`

3. **Monitor Usage**:
   - Check Railway dashboard for usage metrics
   - Set up billing alerts

4. **Idle Detection**:
   - Railway can pause services after inactivity
   - Enable in Project Settings (Hobby tier)

## üîí Security Best Practices

1. **Secret Management**:
   - Never commit secrets to Git
   - Use Railway's environment variables
   - Rotate secrets regularly

2. **Database Security**:
   - Use Railway's private networking
   - Don't expose database publicly
   - Regular backups (Railway provides automatic backups)

3. **SSL/TLS**:
   - Always use HTTPS in production
   - Railway handles certificate renewal

4. **Access Control**:
   - Use Railway's team features
   - Limit who can deploy
   - Use separate projects for dev/staging/prod

5. **Monitoring**:
   - Enable Railway's logging
   - Set up alerts for errors
   - Monitor security events in Django admin

## üì¶ Backup & Restore

### Database Backups:

Railway Pro provides automatic daily backups.

**Manual Backup**:
```bash
# Export database
railway run pg_dump $DATABASE_URL > backup.sql

# Restore database
railway run psql $DATABASE_URL < backup.sql
```

### Redis Backups:

Redis on Railway uses AOF (Append-Only File) persistence.

```bash
# Backup Redis data
railway run redis-cli --rdb /tmp/dump.rdb
```

## üö¶ CI/CD Integration

### GitHub Actions Example:

```yaml
name: Deploy to Railway

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Use Railway CLI
        uses: railway-app/railway-cli@v3
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        with:
          command: up
```

## üìö Additional Resources

- **Railway Documentation**: https://docs.railway.app
- **Railway Discord**: https://discord.gg/railway
- **Django Deployment**: https://docs.djangoproject.com/en/stable/howto/deployment/
- **Celery on Railway**: https://docs.celeryproject.org/en/stable/

## ‚úÖ Post-Deployment Checklist

- [ ] All 5 services deployed successfully
- [ ] Database migrations completed
- [ ] Static files collected and served
- [ ] Environment variables configured
- [ ] Custom domain configured (if applicable)
- [ ] SSL certificate active
- [ ] Health checks passing
- [ ] Celery worker processing tasks
- [ ] Celery beat scheduling tasks
- [ ] Logs accessible and monitored
- [ ] Backups configured
- [ ] Security settings verified
- [ ] Created superuser: `railway run python manage.py createsuperuser`
- [ ] Tested admin interface
- [ ] Tested API endpoints
- [ ] Reviewed security hardening settings

## üéØ Quick Commands Reference

```bash
# View status
railway status

# View logs (real-time)
railway logs -f

# Run migrations
railway run python manage.py migrate

# Create superuser
railway run python manage.py createsuperuser

# Collect static files
railway run python manage.py collectstatic --noinput

# Django shell
railway run python manage.py shell

# Database shell
railway run python manage.py dbshell

# Check Celery workers
railway run --service celery-worker celery -A enginel inspect active

# Restart service
railway restart --service web

# Set environment variable
railway variables set KEY=VALUE

# View environment variables
railway variables

# Deploy current directory
railway up
```

---

**Need Help?** Check the [Railway Discord](https://discord.gg/railway) or [GitHub Issues](https://github.com/yourusername/enginel/issues)
