# Deploying Enginel to Render

This guide walks you through deploying the Enginel application to Render.

## Prerequisites

- GitHub account with your code pushed
- Render account (sign up at https://render.com)
- AWS S3 bucket configured
- Domain name (optional, Render provides a free subdomain)

## Files Created for Deployment

- `render.yaml` - Blueprint defining all services
- `enginel/requirements-prod.txt` - Production dependencies
- `enginel/build.sh` - Build script for deployment
- `enginel/start.sh` - Server start script

## Deployment Steps

### 1. Prepare Your Repository

**Push all changes to GitHub:**
```bash
git add .
git commit -m "Add Render deployment configuration"
git push origin main
```

### 2. Connect to Render

1. Go to https://dashboard.render.com
2. Click **"New +"** → **"Blueprint"**
3. Connect your GitHub account
4. Select the `Enginel` repository
5. Render will detect `render.yaml` automatically

### 3. Configure Environment Variables

After creating the blueprint, configure these **required** environment variables:

#### Web Service (`enginel-web`)

**Security:**
- `SECRET_KEY` - Auto-generated by Render ✓
- `ALLOWED_HOSTS` - Your domain(s): `your-app.onrender.com,yourdomain.com`
- `CSRF_TRUSTED_ORIGINS` - `https://your-app.onrender.com,https://yourdomain.com`
- `CORS_ALLOWED_ORIGINS` - Same as CSRF_TRUSTED_ORIGINS

**AWS S3:**
- `AWS_ACCESS_KEY_ID` - Your AWS access key
- `AWS_SECRET_ACCESS_KEY` - Your AWS secret key
- `AWS_STORAGE_BUCKET_NAME` - Your S3 bucket name
- `AWS_S3_REGION_NAME` - Already set to `us-west-2`
- `AWS_S3_CUSTOM_DOMAIN` - `your-bucket.s3.amazonaws.com` (optional)

**Email (optional):**
- `EMAIL_HOST` - SMTP server (e.g., `smtp.gmail.com`)
- `EMAIL_HOST_USER` - Your email
- `EMAIL_HOST_PASSWORD` - App password
- `DEFAULT_FROM_EMAIL` - From address

**Database & Redis:**
- `DATABASE_URL` - Auto-configured by Render ✓
- `REDIS_URL` - Auto-configured by Render ✓

#### Worker Services

Celery workers inherit most environment variables but need:
- `SECRET_KEY` - Copy from web service
- `AWS_ACCESS_KEY_ID` - Copy from web service
- `AWS_SECRET_ACCESS_KEY` - Copy from web service
- `AWS_STORAGE_BUCKET_NAME` - Copy from web service

### 4. Deploy

1. Click **"Apply"** in Render dashboard
2. Render will:
   - Create PostgreSQL database
   - Create Redis instance
   - Build and deploy web service
   - Deploy Celery worker
   - Deploy Celery beat scheduler

**Build takes ~5-10 minutes on first deploy.**

### 5. Run Initial Setup

After deployment completes:

1. Go to your web service in Render dashboard
2. Click **"Shell"** tab
3. Create a superuser:
```bash
python manage.py createsuperuser
```

### 6. Verify Deployment

Visit your deployed app:
- Web: `https://your-app.onrender.com/api/`
- Admin: `https://your-app.onrender.com/admin/`

Check service logs in Render dashboard:
- **Web** - Application requests
- **Celery Worker** - Background tasks
- **Celery Beat** - Scheduled tasks
- **Database** - Connection info
- **Redis** - Cache status

## Service Configuration

### Services Deployed

| Service | Type | Purpose | Plan |
|---------|------|---------|------|
| `enginel-db` | PostgreSQL | Database | Starter ($7/mo) |
| `enginel-redis` | Redis | Cache & Celery broker | Starter ($10/mo) |
| `enginel-web` | Web Service | Django API | Starter ($7/mo) |
| `enginel-celery-worker` | Background Worker | Process tasks | Starter ($7/mo) |
| `enginel-celery-beat` | Background Worker | Task scheduler | Starter ($7/mo) |

**Total: ~$38/month** (Starter plan)

### Free Tier Option

Render offers free tier with limitations:
- Services spin down after 15 min inactivity
- 750 hours/month free
- 512 MB RAM

To use free tier, change `plan: starter` to `plan: free` in `render.yaml`.

## Post-Deployment

### Custom Domain

1. Go to web service settings
2. Click **"Custom Domain"**
3. Add your domain
4. Update DNS records as shown
5. Update `ALLOWED_HOSTS` and `CSRF_TRUSTED_ORIGINS`

### HTTPS

Render provides free automatic HTTPS via Let's Encrypt.

### Monitoring

Enable health checks:
- Web service: `/api/` (already configured)
- Database: Automatic monitoring
- Redis: Automatic monitoring

### Scaling

To scale services:
1. Go to service in dashboard
2. Click **"Settings"**
3. Change **"Instance Type"** for more resources
4. Increase **"Instance Count"** for horizontal scaling

### Environment Updates

To update environment variables:
1. Go to service settings
2. Update variables
3. Click **"Save Changes"**
4. Render auto-redeploys

## CI/CD

Render automatically deploys on git push to `main` branch.

**To disable auto-deploy:**
1. Go to service settings
2. Set `autoDeploy: false` in `render.yaml`, or
3. Uncheck "Auto-Deploy" in dashboard

**Manual deploy:**
1. Go to service
2. Click **"Manual Deploy"** → **"Deploy latest commit"**

## Troubleshooting

### Build Fails

**Check build logs:**
```bash
# In Render shell
pip list  # Check installed packages
python manage.py check  # Django system check
```

**Common issues:**
- Missing environment variables
- Database connection errors
- Redis connection errors

### Application Errors

**View logs:**
1. Go to service in dashboard
2. Click **"Logs"** tab
3. Check for errors

**Common fixes:**
- Run migrations: `python manage.py migrate`
- Collect static files: `python manage.py collectstatic --no-input`
- Check `ALLOWED_HOSTS` includes your domain

### Database Issues

**Reset database (⚠️ destroys data):**
1. Go to database in dashboard
2. Click **"Danger Zone"** → **"Delete Database"**
3. Recreate via blueprint

**Run migrations manually:**
```bash
# In web service shell
python manage.py migrate
```

### Celery Not Processing Tasks

**Check worker logs:**
1. Go to `enginel-celery-worker` in dashboard
2. Check logs for errors

**Restart worker:**
1. Go to worker service
2. Click **"Manual Deploy"** → **"Clear build cache & deploy"**

### Redis Connection Issues

**Check Redis URL:**
```bash
# In web service shell
echo $REDIS_URL
python -c "import os; print(os.getenv('REDIS_URL'))"
```

**Test Redis connection:**
```bash
# In web service shell
python manage.py shell
>>> from django.core.cache import cache
>>> cache.set('test', 'value')
>>> cache.get('test')
'value'
```

## Security Checklist

Before going live:

- [ ] `DEBUG = False` (already configured)
- [ ] Strong `SECRET_KEY` generated by Render
- [ ] `ALLOWED_HOSTS` configured with your domains
- [ ] `CSRF_TRUSTED_ORIGINS` configured
- [ ] AWS credentials secured
- [ ] Database backups enabled (Render does this automatically)
- [ ] Security headers enabled (already configured)
- [ ] Rate limiting configured (already configured)
- [ ] HTTPS enabled (automatic on Render)
- [ ] IP whitelisting configured if needed
- [ ] Review security settings in `SECURITY_HARDENING.md`

## Backup Strategy

**Database Backups:**
- Render automatically backs up PostgreSQL daily
- Manual backup: Dashboard → Database → "Backups" tab

**Code Backups:**
- Git repository is your source of truth
- Tag releases: `git tag v1.0.0 && git push --tags`

## Cost Optimization

**Reduce costs:**
1. Use free tier for non-production
2. Combine Celery worker and beat into one service
3. Use smaller instance types
4. Scale down during low-traffic periods

**Monitor usage:**
- Dashboard shows resource usage
- Set up billing alerts in account settings

## Support

**Render Documentation:**
- https://render.com/docs

**Render Community:**
- https://community.render.com

**Django Deployment:**
- https://docs.djangoproject.com/en/stable/howto/deployment/

## Next Steps

1. **Monitor Performance** - Check logs and metrics
2. **Set Up Alerts** - Email notifications for errors
3. **Enable Backups** - Verify database backup schedule
4. **Custom Domain** - Add your domain name
5. **SSL Certificate** - Automatic, verify HTTPS works
6. **Load Testing** - Test application under load
7. **Documentation** - Update team docs with URLs and credentials
8. **Security Audit** - Review `SECURITY_HARDENING.md` checklist

## Quick Reference

**Deploy Commands:**
```bash
# Push changes (triggers auto-deploy)
git push origin main

# View logs
# Use Render dashboard → Service → Logs

# Run migrations
# Use Render shell → python manage.py migrate

# Create superuser
# Use Render shell → python manage.py createsuperuser

# Collect static files
# Automatic via build.sh
```

**Useful Render CLI:**
```bash
# Install Render CLI
npm install -g render-cli

# Login
render login

# List services
render services list

# View logs
render logs <service-name>

# Restart service
render deploy <service-name>
```

## Production URLs

After deployment, save these URLs:

- **Web App:** `https://enginel-web.onrender.com`
- **API Docs:** `https://enginel-web.onrender.com/api/`
- **Admin:** `https://enginel-web.onrender.com/admin/`
- **Database:** Connection string in environment
- **Redis:** Connection string in environment

---

**Ready to deploy!** Follow the steps above and your application will be live in ~10 minutes.
